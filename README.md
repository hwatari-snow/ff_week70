# Week 70 - Snowflake クエリパフォーマンス分析

このプロジェクトは、Snowflakeでのクエリパフォーマンス分析を行うためのSQLスクリプト集です。

## 📋 概要

`week_70.sql`には以下の内容が含まれています：

1. **サンプルクエリ群** - パフォーマンス測定対象となるクエリ
2. **パフォーマンス分析クエリ** - 実行されたクエリの性能を分析するためのクエリ

## 🗂️ ファイル構成

```
week70/
├── week_70.sql    # メインのSQLスクリプト
└── README.md      # このファイル
```

## 🚀 使用方法

### 1. セットアップ
```sql
-- セッション設定（クエリタグの設定）
ALTER SESSION SET query_tag = 'ff_challenge';
```

### 2. サンプルクエリの実行
スクリプト内の以下のクエリを実行してサンプルデータを生成：

- **ランダムクエリ**
  - 全件取得
  - 国別カウント
  - 電話番号での検索

- **パターン化クエリ**
  - 市場セグメント別での全列取得（4パターン）
  - 市場セグメント + 国キーでの特定列取得（2パターン）

### 3. パフォーマンス分析の実行
サンプルクエリ実行後、以下の分析クエリで性能を確認：

## 📊 分析クエリ一覧

### 1. 基本的なクエリ実行履歴の分析
```sql
-- 実行回数順でクエリを表示
-- 出力: query_text, count, total_elapsed_time
```

### 2. クエリ時間の平均
```sql
-- 平均実行時間順でクエリを表示
-- 出力: query_text, count, total_elapsed_time, avg_elapsed_time
```

### 3. 長時間実行クエリの特定（5秒以上）
```sql
-- パフォーマンス問題のあるクエリを特定
-- 出力: query_id, query_preview, user_name, warehouse_name, start_time, execution_seconds, bytes_scanned, rows_produced
```

### 4. 大量データスキャンクエリの特定（1MB以上）
```sql
-- 高コストなクエリを特定
-- 出力: query_id, query_preview, user_name, warehouse_name, start_time, execution_seconds, mb_scanned, rows_produced
```

## 🎯 使用シナリオ

### シナリオ1: クエリパフォーマンスの基本分析
1. サンプルクエリを複数回実行
2. 分析クエリ1, 2を実行して実行パターンを確認

### シナリオ2: パフォーマンス問題の特定
1. 分析クエリ3を実行して長時間実行クエリを特定
2. 分析クエリ4を実行して高コストクエリを特定
3. 問題のあるクエリの最適化を検討

### シナリオ3: 定期的なモニタリング
1. 定期的に全分析クエリを実行
2. パフォーマンスの変化をトラッキング
3. 必要に応じてウェアハウスサイズやクエリの調整

## 📈 分析結果の活用方法

### パフォーマンス最適化のポイント
- **実行時間が長いクエリ** → インデックス追加、クエリリファクタリング
- **データスキャン量が多いクエリ** → WHERE句の最適化、パーティション活用
- **頻繁に実行されるクエリ** → キャッシュ戦略の検討

### コスト最適化のポイント
- **MB単位でのデータスキャン量** → クエリの効率化
- **実行頻度** → 不要なクエリの削減
- **ウェアハウス使用時間** → 適切なウェアハウスサイズの選択

## 🔧 前提条件

- Snowflakeアカウントへのアクセス権限
- `SNOWFLAKE_SAMPLE_DATA.TPCH_SF1.CUSTOMER`テーブルへの読み取り権限
- `information_schema.query_history`への読み取り権限

## 📝 注意事項

- クエリタグ`'ff_challenge'`が設定されたクエリのみが分析対象となります
- `information_schema`への問い合わせクエリは分析対象から除外されます
- クエリ履歴の取得上限は1000件に設定されています

## 🤝 貢献

このプロジェクトへの改善提案や追加分析クエリのアイデアがありましたら、お気軽にご連絡ください。

---

**最終更新日**: 2025年9月14日
